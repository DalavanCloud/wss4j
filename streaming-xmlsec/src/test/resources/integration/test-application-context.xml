<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:beans="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:sec="http://cxf.apache.org/configuration/security"
       xmlns:http="http://cxf.apache.org/transports/http/configuration"
       xmlns:httpj="http://cxf.apache.org/transports/http-jetty/configuration"
       xmlns:jaxws="http://cxf.apache.org/jaxws"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd
       http://cxf.apache.org/transports/http/configuration http://cxf.apache.org/schemas/configuration/http-conf.xsd
       http://cxf.apache.org/transports/http-jetty/configuration http://cxf.apache.org/schemas/configuration/http-jetty.xsd
       http://cxf.apache.org/configuration/security http://cxf.apache.org/schemas/configuration/security.xsd">

    <import resource="classpath:META-INF/cxf/cxf.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-extension-soap.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-servlet.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-extension-http.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-extension-http-jetty.xml"/>

    <bean id="greeterServiceImpl" class="org.swssf.test.integration.GreeterServiceImpl">
    </bean>

    <jaxws:endpoint id="greeterService" implementor="#greeterServiceImpl"
                    wsdlLocation="classpath:integration/helloWorld.wsdl"                    
                    address="http://localhost:9001/GreeterService">
        <jaxws:inInterceptors>
            <ref bean="securityInInterceptor"/>
        </jaxws:inInterceptors>
        <jaxws:outInterceptors>
            <ref bean="securityOutInterceptor"/>
        </jaxws:outInterceptors>
    </jaxws:endpoint>

    <bean name="securityInInterceptor" class="org.swssf.interceptor.SecurityInInterceptor">
        <constructor-arg index="0" value="post-stream"/>
        <constructor-arg index="1" ref="securityProperties"/>
    </bean>

    <bean name="securityOutInterceptor" class="org.swssf.interceptor.SecurityOutInterceptor">
        <constructor-arg index="0" value="pre-stream"/>
        <constructor-arg index="1" ref="securityProperties"/>
    </bean>

    <bean name="securityProperties" class="org.swssf.ext.SecurityProperties">
        <property name="callbackHandler" ref="callbackHandler"/>
        <property name="outAction">
            <list>
                <!--<value>TIMESTAMP</value>
                <value>SIGNATURE</value>-->
                <value>ENCRYPT</value>
            </list>
        </property>
        <property name="encryptionUser" value="transmitter"/>
        <property name="skipDocumentEvents" value="true"/>
    </bean>

    <!-- set decryptionKeystore in securityProperties -->
    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="securityProperties"/>
        <property name="targetMethod" value="loadDecryptionKeystore"/>
        <property name="arguments">
            <list>
                <value>classpath:receiver.jks</value>
                <value>default</value>
            </list>
        </property>
    </bean>

    <!-- set signature verfiication Keystore in securityProperties -->
    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="securityProperties"/>
        <property name="targetMethod" value="loadSignatureVerificationKeystore"/>
        <property name="arguments">
            <list>
                <value>classpath:receiver.jks</value>
                <value>default</value>
            </list>
        </property>
    </bean>

    <!-- set signature Keystore in securityProperties -->
    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="securityProperties"/>
        <property name="targetMethod" value="loadSignatureKeyStore"/>
        <property name="arguments">
            <list>
                <value>classpath:transmitter.jks</value>
                <value>default</value>
            </list>
        </property>
    </bean>

    <!-- set signature Keystore in securityProperties -->
    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="securityProperties"/>
        <property name="targetMethod" value="loadEncryptionKeystore"/>
        <property name="arguments">
            <list>
                <value>classpath:transmitter.jks</value>
                <value>default</value>
            </list>
        </property>
    </bean>

    <bean name="callbackHandler" class="org.swssf.test.CallbackHandlerImpl">
    </bean>


    <jaxws:endpoint id="greeterServiceWSS4J" implementor="#greeterServiceImpl"
                    wsdlLocation="classpath:integration/helloWorld.wsdl"
                    address="http://localhost:9001/GreeterServiceWSS4J">
        <jaxws:inInterceptors>
            <ref bean="wss4jInInterceptor"/>
        </jaxws:inInterceptors>
        <jaxws:outInterceptors>
            <ref bean="wss4jOutInterceptor"/>
        </jaxws:outInterceptors>
    </jaxws:endpoint>
    
    <bean name="wss4jInInterceptor" class="org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor">
        <property name="properties">
            <map>
                <entry key="action" value="Encrypt"/>
                <entry key="passwordCallbackRef" value-ref="passwordCallbackHandlerWSS4J"/>
                <entry key="decryptionPropFile" value="integration/receiver-crypto.properties"/>
                <entry key="signaturePropFile" value="integration/receiver-crypto.properties"/>
            </map>
        </property>
    </bean>

    <bean name="wss4jOutInterceptor" class="org.apache.cxf.ws.security.wss4j.WSS4JOutInterceptor">
        <property name="properties">
            <map>
                <entry key="action" value="Encrypt"/>
                <entry key="passwordCallbackRef" value-ref="passwordCallbackHandlerWSS4J"/>
                <entry key="encryptionPropFile" value="integration/transmitter-crypto.properties"/>
                <entry key="signaturePropFile" value="integration/receiver-crypto.properties"/>
                <entry key="user" value="receiver"/>
                <entry key="encryptionUser" value="transmitter"/>
            </map>
        </property>
    </bean>

    <bean name="passwordCallbackHandlerWSS4J" class="org.swssf.test.WSS4JCallbackHandlerImpl">
    </bean>

    <httpj:engine-factory bus="cxf">
        <httpj:engine port="9001">
            <httpj:threadingParameters minThreads="50"
                                       maxThreads="200"/>
            <!--      <httpj:connector>
                    <beans:bean class="org.mortbay.jetty.bio.SocketConnector">
                       <beans:property name="port" value="9001" />
                    </beans:bean>
                  </httpj:connector>
            -->
            <httpj:handlers>
                <beans:bean class="org.mortbay.jetty.handler.DefaultHandler"/>
            </httpj:handlers>
            <httpj:sessionSupport>false</httpj:sessionSupport>
        </httpj:engine>
    </httpj:engine-factory>
</beans>
